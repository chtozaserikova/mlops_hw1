Проект представляет собой ML-микросервис, обернутый в Docker-инфраструктуру. Он включает в себя REST API, gRPC сервис, Streamlit дашборд, а также настроенные инструменты для MLOps: MLflow (трекинг экспериментов), MinIO (S3-хранилище) и DVC (версионирование данных).

Проект поддерживает два режима запуска:
1.  **Полностью в Docker Compose** (все сервисы и инфраструктура).
2.  **Гибридный режим с Kubernetes** (Инфраструктура в Docker, приложения в Minikube).

## Состав группы
1) **Семина Наталья** (отвечала за REST API, Streamlit дашборд и Docker/Compose, makefile, readme)
2) **Серикова Светлана** (отвечала за gRPC сервис, ML-логику, DVC и MLflow, тестирование)

---

## Управление запуском (Скрипты автоматизации)

Для удобства управления проектом реализованы скрипты автоматизации запуска и остановки.

### Вариант 1: Docker Compose (Основной)
Запускает всю инфраструктуру и приложения (REST API, gRPC, Dashboard) в контейнерах Docker. Это рекомендуемый способ для локальной разработки.

**Запуск:**
```bash
chmod +x run_docker_mode.sh
./run_docker_mode.sh
```

Доступные интерфейсы:
| Сервис | Адрес | Описание |
|---|---|---|
| Streamlit Dashboard | http://localhost:8501 | UI для обучения и предсказания (Начните отсюда!) |
| REST API (Swagger) | http://localhost:5000 | Документация API |
| MLflow UI | http://localhost:5002 | Графики метрик и артефакты моделей |
| MinIO Console | http://localhost:9001 | Админка S3 (login/pass: minioadmin) |

### Вариант 2: Гибридный режим (Kubernetes / Minikube)
В этом режиме инфраструктура данных (MinIO, MLflow, PostgreSQL) поднимается в Docker Compose, а приложения (Flask API, gRPC, Dashboard) деплоятся в кластер Minikube.

Скрипт автоматически выполняет следующие действия:
- Поднимает инфраструктуру в Docker.
- Собирает Docker-образ приложения.
- Загружает образ внутрь Minikube.
- Применяет Kubernetes манифесты.

**Запуск:**
```bash
chmod +x run_k8s_mode.sh
./run_k8s_mode.sh
```

**Как узнать адрес?**  
Актуальный IP-адрес и порт сервиса в Kubernetes будут выведены в консоль в конце выполнения скрипта.

---

## Автоматизация разработки (Makefile)
Для упрощения рутинных задач разработчика добавлен `Makefile`. Он позволяет запускать тесты, проверки и сборку короткими командами.

| Команда | Описание |
|---|---|
| `make test` | Запуск unit-тестов через pytest (с автоматической настройкой окружения). |
| `make lint` | Запуск статического анализа кода (pylint). |
| `make build-push` | Сборка Docker-образа и отправка его в Docker Hub. |


**make test** поддерживает запуск двух тестов:
- ТЕСТ А (Unit-тест логики)
Этот тест проверяет функцию подготовки данных, чтобы убедиться, что строковые параметры из конфига корректно превращаются в числа и не сломают обучение модели.
- ТЕСТ Б (Тест с Моком)
Этот тест имитирует процесс обучения и проверяет, что код правильно вызывает команды MLflow (запись метрик, параметров и модели), используя при этом "куклу" вместо реального сервера.

**Особенности сборки:**
Команда `build-push` по умолчанию использует имя пользователя, прописанное в Makefile. Чтобы собрать образ для другого пользователя без изменения кода, можно передать переменную при запуске:

```bash
make build-push DOCKER_USERNAME=my_custom_user
```

## Остановка и очистка

Чтобы корректно остановить и Docker-контейнеры, и ресурсы Kubernetes, а также очистить всё, используйте общий скрипт:

```bash
chmod +x stop_all.sh
./stop_all.sh
```

---

## Тестирование

Скрипты тестирования запускаются с локального компьютера.

### Тестирование REST API (через curl):

```bash
chmod +x test_flask_api.sh
./test_flask_api.sh
```

### Тестирование gRPC:
```bash
python grpc_client_test.py
```

Скрипт проверяет полный цикл: HealthCheck -> Обучение -> Предсказание -> Переобучение (с созданием новой версии в MLflow) -> Удаление.

После выполнения вы увидите, что все методы gRPC успешно отработали:
- HealthCheck — проверка статуса сервиса  
- GetModelClasses — получение списка доступных моделей  
- TrainModel — обучение модели на тестовых данных  
- ListModels — вывод списка обученных моделей  
- GetModel — получение информации о модели  
- Predict — выполнение предсказаний  
- GetMetrics — получение метрик модели  
- RetrainModel — переобучение модели  
- DeleteModel — удаление модели  

---

## Архитектура и Технический стек

### 1. Микросервисы (Python 3.10)

#### REST API (порт 5000) — Публичный интерфейс
- Реализован на Flask + Flask-RESTX.
- OAuth аутентификация через GitHub.
- Swagger документация доступна на http://localhost:5000.
- Предназначен для внешних клиентов и веб-интерфейсов.

#### gRPC API (порт 50051)
- Внутренний высокопроизводительный интерфейс — без аутентификации.
- Предназначен для внутренних сервисов и тестов.
- Клиентский скрипт: `python grpc_client_test.py`.

#### Интерактивный дашборд (порт 8501)
- Визуальный интерфейс на Streamlit.
- Общается с REST API внутри Docker-сети (или K8s network).

---

### 2. MLOps Инфраструктура

#### MLflow (http://localhost:5002):
- Трекинг метрик (Accuracy, Precision, Recall).
- Model Registry (сохранение моделей).
- Backend Store: PostgreSQL.
- Artifact Store: MinIO (S3).

#### MinIO (http://localhost:9001):
- Локальный аналог AWS S3.
- Используется для хранения датасетов (DVC) и моделей (MLflow).

#### DVC (Data Version Control):
- Версионирование датасетов.
- Remote storage настроен на локальный MinIO.
- Команды: `dvc push` / `dvc pull`.

---

### 3. Контейнеризация и Оркестрация
- **Docker**: Все сервисы упакованы в Docker-образы.
- **Docker Compose**: Используется для запуска MLOps-инфраструктуры (и приложений в режиме Docker Mode).
- **Kubernetes (Minikube)**: Поддерживается деплоймент приложений через манифесты.

---

## Аутентификация

### GitHub OAuth в REST API
Для доступа к REST API требуется аутентификация через GitHub:

- При первом обращении перенаправляет на GitHub OAuth (если не были автоматически перенаправлены, добавить `/login` к текущему адресу).
- После успешной аутентификации возвращает на сервис.
- Сессия сохраняется для последующих запросов.

---

## Содержание репозитория

### Скрипты запуска
- `run_docker_mode.sh` — запуск проекта в Docker Compose.
- `run_k8s_mode.sh` — гибридный запуск (инфраструктура в Docker, приложения в Minikube).
- `stop_all.sh` — остановка всех сервисов и очистка ресурсов.

### Логика сервиса
- `app.py` — Flask REST API + Swagger + GitHub OAuth.
- `models.py` — ML-ядро. Интеграция с MLflow и sklearn, работа с БД.
- `grpc_server.py` — реализация gRPC сервиса.
- `dashboard.py` — реализация интерактивного дашборда на Streamlit.
- `app.proto` — описание gRPC API.
- `app_pb2.py`, `app_pb2_grpc.py` — сгенерированные файлы protobuf.

### Конфигурация
- `Dockerfile` — инструкция сборки основного образа.
- `docker-compose.yaml` — описание всей инфраструктуры.
- `k8s/` — папка с манифестами Kubernetes (deployment, service и т.д.).

### Данные и DVC
- `data/` — папка с данными.
- `data/train.csv.dvc` — метаданные DVC для трекинга датасета.
- `init_dvc.sh` — скрипт для инициализации DVC и настройки remote на MinIO.

### Управление зависимостями и тесты
- `pyproject.toml` — конфигурация Poetry.
- `poetry.lock` — фиксированные версии всех зависимостей.
- `grpc_client_test.py` — клиент для проверки gRPC-интерфейса.
- `test_flask_api.sh` — bash-скрипт для базового тестирования REST API.
- `Makefile` — сценарии автоматизации (тесты, линтер, сборка).
- `tests/` — папка с unit и mock тестами.
